#!/bin/sh
#
# Copyright (C) 2006 Stefanos Harhalakis
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
#
# $Id$
#
# The main backup script
#

prefix="@prefix@"
exec_prefix="@exec_prefix@"
bindir="@bindir@"
sbindir="@sbindir@"
libexecdir="@libexecdir@"
localstatedir="@localstatedir@"
libdir="@libdir@"
sysconfdir="@sysconfdir@"
datadir="@datadir@"
mybindir="@mybindir@"
myscriptdir="@myscriptdir@"
myconfdir="@myconfdir@"
sampledir="@sampledir@"

# Location of main programs
B_BINDIR="$mybindir"
# Location of backup scripts
B_SCRIPTDIR="$myscriptdir"
# Name of the master configuration file
B_MASTERCFG="master"

# Show generic help
do_help()
{
	cat << _END
Usage:
	sbackup <backup configuration dir>
		To perform backup based on this dir

     or sbackup --list
		To list all available backup scripts

     or sbackup --check <back configuration dir>
                To check configuration for all files in dir

     or sbackup --help
                To get this help

        Directories must be absolute paths or they will be prepended
	with $myconfdir

_END
	exit 0
}

# Validate a configuration directory name
# $1 is the directory name
validate_dir()
{
	if [ ! -d "$1" ] ; then
		echo "No such directory: $1"
		exit 1
	fi
}

# Load the master configuration file
do_loadmastercfg()
{
	# Load master configuration file
	if [ ! -f "$1"/$B_MASTERCFG ] ; then
		echo "Master configuration file not found: $1/$B_MASTERCFG"
		exit 1
	fi

	. "$1"/$B_MASTERCFG ]

	# validate it
	do_checkmaster

}

# List available scripts
do_list()
{
	$B_BINDIR/run --list
	exit 0
}

# Check configuration
# $1 is the directory
do_check()
{
	validate_dir "$1"
	# TODO:
}

do_checkmaster_one()
{
	local	T

	T=`eval echo '$'{$1}`
	
	if [ -z "$T" ] ; then
		echo "Required variable was undefined: $1"
		exit 1
	fi
}

# Check the master configuration file
do_checkmaster()
{
	local	v

	for v in BACKUPDIR ; do
		do_checkmaster_one $v
	done
}

# Run the backup configuration files
# $1 is the directory
do_run()
{
	if [ ! "$1" = "${1#.}" ] ; then
		echo "Bad path: $1"
		echo "Path must not begin with a dot"
		exit 1
	fi

	if [ "$1" = "${1#/}" ] ; then
		CONFDIR="${myconfdir}/$1"
	else
		CONFDIR="$1"
	fi

	echo "Using $CONFDIR"

	validate_dir "$CONFDIR"

	do_loadmastercfg "$CONFDIR"

	# TODO: Run, check exit code
	cd "$CONFDIR"
	find . -maxdepth 1 -type f | sort |
		while read fn ; do
			D=`echo "$fn" | awk -F . '{print $NF}'`
			T=`echo "$fn" | grep '^[0-9]'`
			if [ ! -z "$T" ] && [ ! -z "$D" ] ; then
				echo "$fn -> $D"
			fi
		done
}

case "$1" in
	--help)
		# Display generic help
		do_help
		;;
	--list)
		# List all available backup scripts
		do_list
		;;
	--check)
		# check configuration
		if [ -z "$2" ] || [ ! -z "$3" ] ; then
			do_help
		fi
		do_check "$2"
		;;
	*)
		# Assume that $1 is the configuration dir name
		if [ -z "$1" ] || [ ! -z "$2" ] ; then
			do_help
		fi

		do_run "$1"
		;;
esac


